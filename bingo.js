        var alt_background = "linear-gradient(to right, #134e5e, #71b280)";

        all_challenges = {"e": { 
            "a": {"description": "No drops", "points": 300, "category": "coli"},
            "b": {"description": "Dragon misses", "points": 50, "category": "coli"},
            "c": {"description": "Enemy misses", "points": 50, "category": "coli"},
            "d": {"description": "Dragon crits", "points": 50, "category": "coli"},
            "e": {"description": "All enemies 1 species", "points": 50, "category": "coli"},
            "f": {"description": "Any familiar", "points": 100, "category": "coli"},
            "g": {"description": "Neutral elem familiar", "points": 200, "category": "coli"},
            "h": {"description": "Venue elem familiar", "points": 200, "category": "coli"},
            "i": {"description": "Swipp or Bald item", "points": 50, "category": "coli"},
            "j": {"description": "5 different items", "points": 200, "category": "coli"},
            "k": {"description": "Get something green", "points": 100, "category": "coli"},
            "l": {"description": "Openable", "points": 100, "category": "coli"},
            "m": {"description": "Captcha", "points": 100, "category": "coli"},
            "n": {"description": "Any battle stone", "points": 100, "category": "coli"},
            "o": {"description": "Health potion", "points": 150, "category": "coli"},
            "p": {"description": "3x 1 item", "points": 200, "category": "coli"},
            "q": {"description": "Free space", "points": 0, "category": "neutral"},
            "r": {"description": "Spend 5 min in coli", "points": 200, "category": "coli"},
            "s": {"description": "Get something brown", "points": 100, "category": "coli"}
                      }, "m": {
            "a": {"description": "Any apparel", "points": 350, "category": "coli"},
            "b": {"description": "Boss fight", "points": 250, "category": "coli"},
            "c": {"description": "Acuity or might fragment", "points": 250, "category": "coli"},
            "d": {"description": "Berserk or scholar stone", "points": 450, "category": "coli"},
            "e": {"description": "Elemental attack stone", "points": 250, "category": "coli"},
            "f": {"description": "Gene", "points": 500, "category": "coli"},
            "g": {"description": "3x Swipp or Bald item", "points": 300, "category": "coli"},
            "h": {"description": "Skin or skin crate", "points": 450, "category": "coli"},
            "i": {"description": "Scroll of renaming", "points": 400, "category": "coli"},
            "j": {"description": "Vista", "points": 450, "category": "coli"},
            "k": {"description": "Eye vial", "points": 550, "category": "coli"},
            "l": {"description": "Max breath on 1 dragon", "points": 350, "category": "coli"},
            "m": {"description": "Do square above or below", "points": 200, "category": "neutral"},
            "n": {"description": "Do square left or right", "points": 200, "category": "neutral"},
            "o": {"description": "Do 2 corner squares", "points": 200, "category": "neutral"},
            "p": {"description": "Spend 15 min in coli", "points": 600, "category": "coli"},
            "q": {"description": "Exactly 6 different items", "points": 550, "category": "coli"}
                    }, "h": {
            "a": {"description": "Boss familiar", "points": 3000, "category": "coli"},
            "b": {"description": "Wing apparel", "points": 2500, "category": "coli"},
            "c": {"description": "Runestone", "points": 2500, "category": "coli"},
            "d": {"description": "Deity doll", "points": 2500, "category": "coli"},
            "e": {"description": "Ambush or rally stone", "points": 1000, "category": "coli"},
            "f": {"description": "2 familiars at once", "points": 2000, "category": "coli"},
            "g": {"description": "Unhatched egg", "points": 3000, "category": "coli"},
            "h": {"description": "Venue apparel", "points": 1000, "category": "coli"},
            "i": {"description": "2 boss fights in a row", "points": 1000, "category": "coli"},
            "j": {"description": "2 misses in a row", "points": 800, "category": "coli"},
            "k": {"description": "Eliminate", "points": 3000, "category": "coli"},
            "l": {"description": "Swipp, Bald, or hibden fam", "points": 1600, "category": "coli"},
            "m": {"description": "Spend 30 min in coli", "points": 1200, "category": "coli"},
            "n": {"description": "3x openable at once", "points": 300, "category": "coli"}
                  }, "s": {
            "a": {"description": "Drink a glass of water", "points": 100, "category": "self-care"},
            "b": {"description": "Head outside", "points": 100, "category": "self-care"},
            "c": {"description": "Do something energetic", "points": 100, "category": "self-care"},
            "d": {"description": "Socialize (online OK!)", "points": 100, "category": "self-care"},
            "e": {"description": "Another glass of water!", "points": 100, "category": "self-care"},
            "f": {"description": "Get 2+ proper meals", "points": 100, "category": "self-care"},
            "g": {"description": "Say something nice about yourself", "points": 100, "category": "self-care"},
            "h": {"description": "Look forward to something", "points": 100, "category": "self-care"},
            "i": {"description": "Brush your teeth", "points": 100, "category": "self-care"},
            "j": {"description": "Touch a live thing (plants OK!)", "points": 100, "category": "self-care"},
            "k": {"description": "Finish a task", "points": 100, "category": "self-care"},
            "l": {"description": "Get dressed", "points": 100, "category": "self-care"},
            "m": {"description": "Free space!", "points": 100, "category": "neutral"},
            "n": {"description": "Meditate, 5+ min", "points": 100, "category": "self-care"},
            "o": {"description": "Put on some music", "points": 100, "category": "self-care"},
            "p": {"description": "Do something with your hands", "points": 100, "category": "self-care"},
            "q": {"description": "ANOTHER glass of water!", "points": 100, "category": "self-care"},
            "r": {"description": "Release shoulder, back, jaw tension", "points": 100, "category": "self-care"},
            "s": {"description": "Stretch!", "points": 100, "category": "self-care"},
            "t": {"description": "Smell something nice", "points": 100, "category": "self-care"},
            "u": {"description": "Create something", "points": 100, "category": "self-care"},
            "v": {"description": "Do something pleasantly mindless", "points": 100, "category": "self-care"},
            "w": {"description": "Learn something new", "points": 100, "category": "self-care"},
            "x": {"description": "10 deep breaths", "points": 100, "category": "self-care"},
            "y": {"description": "Work on a good habit", "points": 100, "category": "self-care"}
        }};

        // `fixed_rarity`: The rarity of plants doesn't grow as you uncover more squares
        const difficulties = {"Easy": {"challenge_set": ["e","e","m"], "starting_rarity": 0, "fixed_rarity": false},
                              "Medium": {"challenge_set": ["e","m","m"], "starting_rarity": 3, "fixed_rarity": false},
                              "Hard": {"challenge_set":  ["e","m","h"], "starting_rarity": 6, "fixed_rarity": false},
                              "Pain": {"challenge_set":  ["m","h"], "starting_rarity": 8, "fixed_rarity": false},
                              "Self-Care": {"challenge_set":  ["s"], "starting_rarity": 7, "fixed_rarity": true}};
        all_difficulty_sets = assemble_difficulty_sets();
        const slot_max_retries = 15;  // how many times to retry having a non-duplicate challenge before allowing duplicates

        // When there are (num) squares revealed, there should be idx_of(num)+1 plants revealed. If not, add another plant.
        // Making it a dict certainly looks a bit silly, but it does make the later code very clean.
        // TODO: Javascript has a list comprehension equivalent (I think?), so clean this up.
        const plants_revealed_at = {3: 1, 7: 2, 11: 3, 15: 4, 20: 5, 25: 6, 30: 7, 35: 8, 41: 9, 47: 10, 49: 11};
        // "At difficulty <Easy>, the first plant is rarity <Easy>[starting_rarity]. It feeds this pattern:
        // 0 0
        // 1 1 1
        // 2 2 2 2
        // 3 3 3 3 3
        // 4 4 4 4 4 4...
        // This holds something like "Easy": {1: 0, ...} to 7 "rows". I have no idea why I'd ever have 2+3...+8=35 plants on one board, but hey.
        const plant_rarity_lookup = calc_rarity_progression();

        const icons = [
           "https://i.imgur.com/GSNkSxm.png",
           "https://i.imgur.com/TuZ3QXY.png",
           "https://i.imgur.com/2Fbxx1b.png",
           "https://i.imgur.com/EHvEUAI.png",
           "https://i.imgur.com/M1AHxdW.png",
           "https://i.imgur.com/sey4Maz.png",
           "https://i.imgur.com/45exDh2.png",
           "https://i.imgur.com/GaJzue4.png"
        ]


        var bingo_border_color = "#71b280";
        var num_squares_revealed = 0;
        var num_plants_revealed = 0;
        var current_board = [];
        var revealed_seeds = [];
        var current_difficulty;
        var bingo_plant_generated = false;  // Used to track whether the bonus bingo seed has been revealed. We don't re-hide seeds.
        var forced_random_seed = null;  // "Child" pages can overwrite with a fixed seed, ex: self_care uses the date as a seed.
        var use_extra_icons = true;  // "Child" pages can use ex: a checkbox to prevent the non-seeded-plant icons from showing up (they might be distracting)

        function randomFromArray(arr){return arr[Math.floor(Math.random()*arr.length)]}

        function calc_rarity_progression(){
            var lookup = {};
            const num_rows = 8;
            // TODO: There's obviously a way to calculate this,..fun later, let's get it working for now.
            current_plant_num = 1;
            for(difficulty in difficulties){
                lookup[difficulty] = {};
                // Fixed_rarity difficulties don't follow the rarity "growth".
                if(difficulties[difficulty]["fixed_rarity"]){
                    // TODO: There's also probably a list comprehension-like construct.
                    for(var i=1; i<36; i++){
                        lookup[difficulty][i] = difficulties[difficulty]["starting_rarity"];
                    }
                    continue;
                }
                // Non-fixed rarity follows the pattern documented at `plant_rarity_lookup`   
                var current_rarity = difficulties[difficulty]["starting_rarity"]
                for(var i=1; i<num_rows; i++){
                    // The +1 here is because the pattern is 0, 0, 1, 1, 1...., not 0, 1, 1...
                    for(var j=0; j<i+1; j++){
                        lookup[difficulty][current_plant_num] = current_rarity;
                        current_plant_num ++;
                    }
                    current_rarity ++;
                }
                current_plant_num = 1;
            }
            return lookup;
        }

        function assemble_difficulty_sets(){
            var all_names = {};
            for(const challenge_difficulty in all_challenges){
                all_names[challenge_difficulty] = [];
                for(const challenge_name in all_challenges[challenge_difficulty]){
                    all_names[challenge_difficulty].push(challenge_difficulty+challenge_name);
                }
            }
            var all_difficulty_sets = {};
            for(const board_difficulty in difficulties){
                all_difficulty_sets[board_difficulty] = [];
                for(var i=0; i< difficulties[board_difficulty]["challenge_set"].length; i++){
                    difficulty_instance = difficulties[board_difficulty]["challenge_set"][i];
                    all_difficulty_sets[board_difficulty] = all_difficulty_sets[board_difficulty].concat(all_names[difficulty_instance]);
                }
            }
            return all_difficulty_sets;
        }

        function getRadioValue(name) {
            var ele = document.getElementsByName(name);
            for(i = 0; i < ele.length; i++) {
                if(ele[i].checked)
                return ele[i].value;
            }
        }

        /* Gawkily randomize in place */
        function shuffleArray(arr) {
          for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
          }
        }

        function assemble_challenge_list(size, difficulty){
            initial_challenge_list = all_difficulty_sets[difficulty];
            var challenges = [];
            while(challenges.length < size*size){
              shuffleArray(initial_challenge_list);
              challenges = challenges.concat(initial_challenge_list);
            }
            return challenges;
        }

        function clear_board() {
          var board = document.getElementById("board_div")
          while (board.lastChild) {
              board.removeChild(board.lastChild);
          }
          current_board = [];
          num_squares_revealed = 0;
          num_plants_revealed = 0;
          bingo_plant_generated = false;
          setBingoPlantVisibility(false);
        }

        function has_bingo() {
          bingo = false;
          // Naive method is fine here don't @ me
          // First we check for horizontal bingo
          for(var i=0; i<current_board.length; i++){
            if(current_board[i][0]["earned"]){
              bingo = true;  // temporary
              for(var j=0; j<current_board[i].length; j++){
                if(!current_board[i][j]["earned"]){
                  bingo = false;
                  break;}}
            if(bingo){break;}
          }}
          if(bingo){return bingo;}
          // Vertical bingo is practically identical
          for(var i=0; i<current_board[0].length; i++){
            if(current_board[0][i]["earned"]){
              bingo = true;  // temporary
              for(var j=0; j<current_board[0].length; j++){
                if(!current_board[j][i]["earned"]){
                  bingo = false;
                  break;}}
            if(bingo){break;}
          }}
          if(bingo){return bingo;}
          // Diagonal bingo
          bingo = true;  // temporary
          for(var i=0; i<current_board.length; i++){
            if(!current_board[i][i]["earned"]){
              bingo = false;
              break;
          }}
          if(bingo){return bingo;}
          bingo = true;  // temporary
          for(var i=0; i<current_board.length; i++){
            if(!current_board[current_board.length-1-i][i]["earned"]){
              bingo = false;
              break;
          }}
          return bingo;
        }

        function generate_board(size, difficulty, rarity_override=null) {
            clear_board();
            current_difficulty = difficulty;  // Make it globally available (not huge on this)
            var board = document.getElementById("board_div");
            var challenges = assemble_challenge_list(size, difficulty);
            for(var i=0; i < size; i++){
              var new_row = document.createElement('div');
              new_row.className = "bingo_row";
              board.appendChild(new_row);
              current_board.push([]);
              for(var j=0; j < size; j++){
                var challenge_name = challenges[i*size+j];
                add_bingo_square(new_row, i, j, challenge_name, rarity_override=rarity_override);
                current_board[i].push({"earned": false,
                                       "challenge": challenge_name,
                                       "icon": icons[Math.floor(Math.random() * icons.length)]});
              }
           }
        }

        // Reveal a plant in a square (either within the board or the "bonus bingo plant"
        // Handles the work of generating the plant itself and adding the seed to the pile.
        // Returns a dataURL to set as an image someplace.
        async function genPlantInSquare(forced_random_offset=0){
            rarity = plant_rarity_lookup[current_difficulty][num_plants_revealed];
            if(forced_random_seed == null){
                plant_data = gen_plant_data(rarity);
            } else {
                // ONLY for forced_random seed generation, the bingo seed needs to increment num_plants_revealed
                plant_data = gen_plant_data(rarity, forced_random_seed+String(num_plants_revealed + bingo_plant_generated));
            }
            plant_canvas = await gen_plant(plant_data);
            // TODO: This next scaling bit seems incredibly silly
            var scale_canvas = document.createElement("canvas");
            scale_canvas.width = 96;
            scale_canvas.height = 96;
            var scale_ctx = scale_canvas.getContext("2d");
            scale_ctx.imageSmoothingEnabled = false;
            scale_ctx.drawImage(plant_canvas, 0, 0, 96, 96);
            revealed_seeds.push(encode_plant_data(plant_data));
            document.getElementById("seed_list").innerHTML = revealed_seeds.join(", ");
            return scale_canvas.toDataURL();
        }

        async function toggle_status(e){
        var id = e.target.id;
        coords = id.split("_");
        var row = parseInt(coords[0]);
        var col = parseInt(coords[1]);
        var square_info = current_board[row][col];
        var bingo_square = document.getElementById(id);
        square_info["earned"] = !square_info["earned"];
        bingo_square.lastChild.style.opacity = 0.2;  // Make label translucent
        if(square_info["earned"]){
          num_squares_revealed ++;
          // Null is treated as 0...Javascript!
          if(num_plants_revealed < plants_revealed_at[num_squares_revealed]){
            // Time to reveal a plant!
            num_plants_revealed ++;
            square_info['icon'] = await genPlantInSquare();
          }
          if(use_extra_icons || !square_info['icon'].startsWith("https://")){
            bingo_square.style.background = 'url(' + square_info["icon"] + ')  no-repeat center center';
          } else {bingo_square.style.background = "none";}
        } else {
          num_squares_revealed --;
          bingo_square.style.background = "none";
          bingo_square.lastChild.style.opacity = 1;
        }
        var body = document.getElementsByTagName("BODY")[0];
        now_has_bingo = has_bingo();
        setBingoPlantVisibility(now_has_bingo);
        if(now_has_bingo){
          transition_all_bingo_borders("#ffffff", row, col);
        } else {
          shimmer_bingo_borders(bingo_border_color, "#b1f2c0", row, col);
        }
        }

        function transition_all_bingo_borders(color, origin_row, origin_column){
        var root_delay = 70;  // in milliseconds
        for(let i=0; i<current_board.length; i++){
            for(let j=0; j<current_board[i].length; j++){
              // Yes these lets are necessary
              let mapped_row = origin_row;
              let mapped_column = origin_column;
              // Delay proportional to distance from origin
              let delay = root_delay*(((mapped_column-j)**2+(mapped_row-i)**2)**(1/2))
              setTimeout( function() {document.getElementById(i+"_"+j).style.borderColor = color;}, delay);
            }
          }
        }

        async function setBingoPlantVisibility(show_plant){
            parent_div = document.getElementById("bingo_plant_container_div");
            if(!show_plant){
                parent_div.style.display = "none";
            } else {
                if(!bingo_plant_generated){
                    // We need this true BEFORE generating the plant (weird I know) in case of a forced random seed. It's how we know to increment.
                    bingo_plant_generated = true;  // Once gained, is only lost when board is reset (to avoid regenerating the bingo plant)
                    data_url = await genPlantInSquare();
                    target_div = document.getElementById("bingo_plant_div");
                    target_div.style.background = 'url(' + data_url + ')  no-repeat center center';
                }
                target_div = document.getElementById("bingo_plant_div");
                parent_div.style.display = "block";
            }
        }

        // Go through and either hide or show all non-generated-plant icons
        function toggleExtraIcons(show_icons){
        for(let i=0; i<current_board.length; i++){
            for(let j=0; j<current_board[i].length; j++){
              bingo_square = document.getElementById(i+"_"+j);
              bingo_square_info = current_board[i][j];
              if(bingo_square_info["earned"] && bingo_square_info['icon'].startsWith("https://")){  // This feels unsafe, somehow
                if(show_icons){bingo_square.style.background = 'url(' + bingo_square_info["icon"] + ')  no-repeat center center';}
                else{bingo_square.style.background = "none";}
              }
            }
          }
        }

        function shimmer_bingo_borders(original_color, new_color, origin_row, origin_column) {
            var root_delay = 100;  // in milliseconds
            for(let i=0; i<current_board.length; i++){
                for(let j=0; j<current_board[i].length; j++){
                  // Yes these lets are necessary
                  let mapped_row = origin_row;
                  let mapped_column = origin_column;
                  // Delay proportional to distance from origin
                  let delay = root_delay*(((mapped_column-j)**2+(mapped_row-i)**2)**(1/2));
                  let flip_delay = delay + 200;
                  setTimeout( function() {document.getElementById(i+"_"+j).style.borderColor = new_color;}, delay);
                  setTimeout( function() {document.getElementById(i+"_"+j).style.borderColor = original_color;}, flip_delay);
                }
            }
        }

        function add_bingo_square(parent, column, row, challenge_name){
            var id = column + "_" + row;
            var bingo_square = document.createElement('div');
            bingo_square.id = id;
            bingo_square.className = 'bingo_box';
            bingo_square.addEventListener("click", toggle_status);
            bingo_square.addEventListener('touchend', function(e){
                    toggle_status(e);
                    e.preventDefault()
                })

            var label = document.createElement('label')
            var challenge = all_challenges[challenge_name[0]][challenge_name.slice(1)];
            label.htmlFor = id;
            label.className = 'bingo_label';
            label.appendChild(document.createTextNode(challenge["description"]));

            bingo_square.appendChild(label);
            parent.appendChild(bingo_square);
        }
