<!DOCTYPE html>
<html>
    <meta charset="utf-8"/>
    <head>
        <title>Utilities [EG]</title>
        <link rel="stylesheet" type="text/css"  href="shared.css" />
        <link rel="icon" href="https://i.imgur.com/13AXCvH.png">
    </head>
    <body onload="do_preload()" style="margin: 0.5%"> <!--Accursed: needed to use a fixed-width scroller since the 8px margin "default" isn't guaranteed-->
        <a href="index.html" class="index_link"><--Home</a>
        <h1 id="title">Your Collection</h1>
        <div id=content_div style="padding: 0px;">
            <div id="collection_horiz_div", class="collection_row">
              <div id=seed_collection_display_container_spacer class=garden_util_box style="width:20%; min-width: 100px; border-width: 0px"></div>
                <div id=seed_info_div class=garden_util_box_fixed style="text-align: left; left: 0.5%">
                  <input type="button" class="chunky_fullwidth" value="Sort" onClick="doFilter()">
                  <h3>Sort By</h2>
                  <input type="radio" id="none_opt" name="sort_order" value="None" checked>
                  <label for="none_opt">Nothing</label><br>
                  <input type="radio" id="base" name="sort_order" value="foliage">
                  <label for="base">Base</label><br>
                  <input type="radio" id="foliage" name="sort_order" value="foliage_palette">
                  <label for="foliage">Foliage Palette</label><br>
                  <input type="radio" id="feature" name="sort_order" value="feature_palette">
                  <label for="feature">Feature Palette</label><br>
                  <input type="radio" id="accent" name="sort_order" value="accent_palette">
                  <label for="accent">Accent Palette</label>
                  <h3>Show Seeds of Type</h2>
                  <div id="base_sort_categories_div"></div>
                  <h3>With Colors</h2>
                  <div id="palette_sort_categories_div"></div>
                  <h3>Display</h2>
                  <input id="hide_seeds" type="checkbox" value="Hide seeds">
                  <label for="hide_seeds">Numbers</label>
                  <input id="show_palettes" type="checkbox">
                  <label for="show_palettes">Palettes</label>
                </div>
              <div id=seed_collection_display_container class=garden_util_box style="width:60%; border: none">
                  <label for="seed_collection">Manually add seeds:</label>
                  <input type="text" id="seed_collection" name="seed_collection" size="4" placeholder="Click here and paste!", style="min-width: 292px;">
                  <input type="button" class="chunky_wrap" value="Add seeds" onClick="display_collection()">
                  <div id="collection_display_div" class="collection_display"></div>
              </div>
              <div id="seed_collection_utility_spacer" class=garden_util_box style="width:20%; min-width: 100px; border-width: 0px"></div>
              <div id=seed_collection_utility_container class=garden_util_box_fixed style="right: 0.5%">
                <div id="utility_button_box" style="height: 25%">
                  <input id="analyze_button" type="button" title="Choose a seed to view info about it" class="chunky_fullwidth active" onclick='changeSelectedFunction("analyze")' value="Analyze"></input></br>
                  <input id="select_button" type="button" title="Choose seeds to copy them their text to your clipboard (for making gardens). Click a chosen seed to deselect. You can select seeds multiple times!" class="chunky_fullwidth" onclick='changeSelectedFunction("select")' value="Select"></input></br>
                  <input id="mutate_button" type="button" title="Choose seeds to merge or mutate" class="chunky_fullwidth" onclick='changeSelectedFunction("mutate")' value="Mutate"></input></br>
                  <input id="recycle_button" type="button" title="Choose seeds to remove from your collection (has confirmation dialogue)" class="chunky_fullwidth" onclick='changeSelectedFunction("recycle")' value="Recycle"></input>
                  <input id="backup_button" type="button" title="Back up your seed collection to your computer. Do it early and often! :) You get 3 rs per day for it (max 15)" class="chunky_fullwidth" onclick='doBackup()' value="Backup"></input>
                </div>
                <div id=analyze_div class=garden_util_box style="height: 70%">
                  <div>
                    <canvas id="analysis_preview_canvas" width="128" height="128"></canvas><br>
                    <canvas id="analysis_output_canvas" width="64" height="64"></canvas><br>
                  </div>
                  <span id="analysis_output_text"></span>
                </div>
                <div id=select_div class=garden_util_box style="height: 70%" hidden>
                    <div style="height: 10%"><input id="select_seed_copy_button" type="button" class="chunky_wrap" value="Copy seedtext" onclick='copy_selection()'></input></div>
                    <div style="max-height: 90%; overflow-y: scroll"><div id="selection_display_div" class="collection_display"></div></div>
                </div>
                <div id=recycle_div class=garden_util_box style="height: 70%" hidden>
                    <div style="height: 10%"><input id="do_recycle_button" type="button" class="chunky_wrap" onclick='launch_recycle_dialogue()' value="Recycle seeds"></input></div>
                    <div style="max-height: 90%; overflow-y: scroll"><div id="recycle_display_div" class="collection_display"></div></div>
                </div>
                <div id=mutate_div class=garden_util_box hidden>
                  <div>
                  </div>
                </div>
              </div>
            </div>
        </div>
      </body>
    <script src="built/gen_plant.js"></script>
    <script src="built/gen_garden.js"></script>
    <script src="built/shared.js"></script>
    <script type="text/javascript">

      var collection_filter = {"base": new Set(), "foliage_palette": new Set(), "feature_palette": new Set(), "accent_palette": new Set()};
      var selected_function = "analyze";
      var sort_intervals = [];
      var days_since_backup;
      const backup_sp_per_day = 3;
      const max_sp_for_backup = 15;

      function doSeedOnclick(e){
        let seed = e.target.getAttribute('data-seed');
        // There's probably some function passing refactor I could do
        if (selected_function == "analyze"){ analyze_seed(seed); }
        else if (selected_function == "select"){ select_seed(seed); }
        else if (selected_function == "recycle"){ prep_recycle_seed(seed); }
        else if (selected_function == "mutate"){ prep_mutate_seed(seed); }
      }

      function doBackup(){
        var a = document.createElement('a');
        var blob = new Blob([getSeedCollectionAsString()], {'type':'application/octet-stream'});
        a.href = window.URL.createObjectURL(blob);
        let d = new Date();
        a.download = "seed_collection_" + new Date().toJSON().slice(0,10) + ".txt";
        a.click();
        addSeedPoints(Math.min(days_since_backup * backup_sp_per_day, max_sp_for_backup));
        localStorage["last_backup"] = new Date();
        document.getElementById("backup_button").value="Backup";
      }

      // Really just a "find the first instance and snip" method
      function removeSeedFromCollection(seed){
        if(localStorage.seed_collection == undefined) { return false;}
        let seed_and_comma = seed + ",";
        let collection = getSeedCollectionAsString();
        let index = collection.indexOf(seed_and_comma);
        if (index != -1) {
          localStorage.seed_collection = collection.slice(0, index) + collection.slice(index + seed_and_comma.length);
          return true;
        }
        // Should only fire if it's the last (or only) seed...or it wasn't found
        index = collection.indexOf(seed);
        if (index != -1) {
          if(collection == seed){ delete localStorage.seed_collection} else {
            localStorage.seed_collection = collection.slice(0, index - 1) + collection.slice(index + seed.length);
          }
          return true;
        }
        return false;
      }

      async function select_seed(seed) {
        let parent = document.getElementById("selection_display_div");
        let entry = await create_collection_entry(parent.children.length, seed, document.getElementById("hide_seeds").checked, document.getElementById("show_palettes").checked);
        entry.onclick = function(){parent.removeChild(entry)};
        parent.appendChild(entry);
      }

      async function prep_recycle_seed(seed) {
        let parent = document.getElementById("recycle_display_div");
        let entry = await create_collection_entry(parent.children.length, seed, document.getElementById("hide_seeds").checked, document.getElementById("show_palettes").checked);
        entry.onclick = function(){parent.removeChild(entry)};
        parent.appendChild(entry);   
      }

      function copy_selection() {
        let parent = document.getElementById("selection_display_div");
        let button = document.getElementById("select_seed_copy_button");
        seed_list = [];
        for(child of parent.children){
          seed_list.push(child.getAttribute("data-seed"));
        }
        navigator.clipboard.writeText(seed_list.join(", "));
        button.value = "Copied!"
        setTimeout(function(){ button.value = "Copy to clipboard"; }, 1000);
      }

      function launch_recycle_dialogue() {
        let modal = document.createElement("div");
        modal.classList.add("block_window");
        let modal_display = document.createElement("div");
        modal_display.classList.add("popup");
        document.body.appendChild(modal);
        let textbox = document.createElement("text");
        textbox.textContent = "You're about to recycle " + document.getElementById("recycle_display_div").children.length + " seed(s). These will be recycled into seed points at a rate of 1 SP per seed found (so don't worry if you accidentally specified duplicates). If you're ready, hit the 'Claim SP' button. If these seeds were added to your collection by mistake and you just want to remove them, hit the 'Delete' button instead!";
        let button_container = document.createElement("div");
        button_container.style.padding = "20px";
        let cancel_button = document.createElement("input");
        cancel_button.type = "button";
        cancel_button.onclick = function() {document.body.removeChild(modal)};
        cancel_button.value = "Cancel";
        cancel_button.classList.add("chunky_fullwidth");
        let claim_button = document.createElement("input");
        claim_button.type = "button";
        function delayedExit(message){
          button_container.removeChild(remove_button);
          button_container.removeChild(claim_button);
          cancel_button.value = "Done!";
          textbox.textContent = message;
        }
        claim_button.onclick = function() {earned = recycle_seeds(true); delayedExit("You now have " + getSeedPoints() + " seed points (" + earned + " more than before)")};
        claim_button.value = "Claim SP";
        claim_button.classList.add("chunky_fullwidth");
        let remove_button = document.createElement("input");
        remove_button.type = "button";
        remove_button.onclick = function() {recycle_seeds(false); delayedExit("Removed errant seeds. Thank you for your honesty!")};
        remove_button.value = "Delete (no SP)";
        remove_button.classList.add("chunky_fullwidth");
        button_container.appendChild(textbox);
        button_container.appendChild(document.createElement("br"));
        button_container.appendChild(document.createElement("br"));
        button_container.appendChild(claim_button);
        button_container.appendChild(remove_button);
        button_container.appendChild(cancel_button);
        modal_display.appendChild(button_container);
        modal.appendChild(modal_display);
      }

      function recycle_seeds(claim_sp){
        seed_list = document.getElementById("recycle_display_div");
        earned_sp = 0;
        // Lots of ways to speed this up, but let's be honest, it's preemptive.
        for(child of seed_list.children){
          seed = child.getAttribute("data-seed");
          found = removeSeedFromCollection(seed);
          if(found){ earned_sp += 1};
        }
        if(claim_sp) { addSeedPoints(earned_sp); }
        seed_list.innerHTML = '';  // Remove all children
        display_collection();
        return earned_sp;
      }

      function changeSelectedFunction(new_selected_function){
        if (new_selected_function==selected_function){
          return
        }
        document.getElementById(selected_function + "_div").setAttribute("hidden", "hidden");
        document.getElementById(new_selected_function + "_div").removeAttribute("hidden");
        document.getElementById(selected_function + "_button").setAttribute("hidden", "hidden");
        document.getElementById(new_selected_function + "_button").classList.add('active');
        document.getElementById(selected_function + "_button").classList.remove('active');
        selected_function = new_selected_function;
      }

      function cancelOngoingSort(){
        for(interval of sort_intervals){
          clearInterval(interval);
        }
      }

      function doFilter(){
        compileFilter();
        display_collection();
      }

      function forceFilter(base, palette){
        collection_filter["base"] = new Set();
        collection_filter["foliage_palette"] = new Set();
        collection_filter["feature_palette"] = new Set();
        collection_filter["accent_palette"] = new Set();
        if(base != -1){
          collection_filter["base"] = new Set([base]);
        }
        if(palette != -1){
          let palette_set = new Set();
          palette_set.add(palette);
          collection_filter["foliage_palette"] = palette_set;
          collection_filter["feature_palette"] = palette_set;
          collection_filter["accent_palette"] = palette_set;
        }
        display_collection();
      }

      function compileFilter(){
        let new_base_set = new Set();
        for(base_filter of document.getElementById("base_sort_categories_div").children){
          if(base_filter.checked){
            foliage_by_category[base_filter.value].forEach((item) => new_base_set.add(item));
          }
        }
        collection_filter["base"] = new_base_set;
        let new_palette_set = new Set();
        for(palette_filter of document.getElementById("palette_sort_categories_div").children){
          if(palette_filter.checked){
            palettes_by_category[palette_filter.value].forEach((item) => new_palette_set.add(item));
          }
        }
        collection_filter["foliage_palette"] = new_palette_set;
        collection_filter["feature_palette"] = new_palette_set;
        collection_filter["accent_palette"] = new_palette_set;
      }

      function applyFilter(filter_name, data_val){
        if(data_val == undefined){ return false;}  // malformed seed
        if(collection_filter[filter_name].size == 0) { return true;}
        return collection_filter[filter_name].has(data_val);
      }

      function passesFilter(plant_data){
        if(!applyFilter("base", plant_data["foliage"])) { return false;}
        if(applyFilter("foliage_palette", plant_data["foliage_palette"])) { return true;}
        if(applyFilter("feature_palette", plant_data["feature_palette"])) { return true;}
        if(applyFilter("accent_palette", plant_data["accent_palette"])) { return true;}
        return false;
      }

      function display_collection() {
          //clear what's already in there
          cancelOngoingSort();
          sort_intervals = [];
          var collection_div = document.getElementById("collection_display_div")
          var hide_seeds = document.getElementById("hide_seeds").checked;
          let show_palettes = document.getElementById("show_palettes").checked;
          while (collection_div.lastChild) {collection_div.removeChild(collection_div.lastChild);}
          var seed_string = document.getElementById("seed_collection").value.split(" ").join("").replace(/(^,)|(,$)|"/g, '');
          // This and the next line both "verify"--sloppy workaround for people putting !namedseeds in this field
          //let [new_seeds, new_named] = sortAndVerifySeedList(seed_string);
          collectSeed(seed_string);
          document.getElementById("seed_collection").value = "";
          let collection = getSeedCollection();
          var sort_order_elem = document.getElementsByName('sort_order');
          var sort_order = "None";
          for(i = 0; i < sort_order_elem.length; i++) {
              if(sort_order_elem[i].checked)
              sort_order = sort_order_elem[i].value;
          }
          collection = get_seed_collection_sorted_by(collection, sort_order);
          if(collection.length > 0){ analyze_seed(collection[0]); }
          //var collection_width_elem = document.getElementsByName('collection_width');
          document.getElementById("title").title = "You have " + collection.length + " seeds and " + getSeedPoints() + " seed points!";
          for(var i=0; i<collection.length; i++){
              sort_intervals.push(setTimeout(add_collection_entry, i, collection_div, i, collection[i], hide_seeds, show_palettes));
          }
      }

    // Take a list of seeds, return them in the order specified (ex: sort by the base "plant")
    function get_seed_collection_sorted_by(collection, sort_key) {
      let needs_filtered = !(collection_filter["base"].size == 0 &&
                             collection_filter["foliage_palette"].size == 0 && collection_filter["feature_palette"].size == 0 &&
                             collection_filter["accent_palette"].size == 0)
      if(sort_key == "None" && !needs_filtered){ return collection};
      parsed_seeds = {};
      let named_seed_data = {"foliage": 999, "foliage_palette": 999, "feature_palette": 999, "accent_palette": 999}
      for(let i=0; i<collection.length; i++){
          if(collection[i].startsWith("!")){
            parsed_seeds[collection[i]] = named_seed_data;
          } else {
            let plant_data = decode_plant_data(collection[i]);
            if (needs_filtered && !passesFilter(plant_data)){
              continue;
            }
            parsed_seeds[collection[i]] = plant_data;
          }
      }
      if(needs_filtered){
        let filtered_collection = [];
          let allowed_seeds = new Set(Object.keys(parsed_seeds));
          for(let entry of collection){
            if (allowed_seeds.has(entry)){filtered_collection.push(entry)}
          }
        collection = filtered_collection;
      }
        
      if(sort_key == "None") { return collection; };
      return collection.sort(function(a, b) {
        return parsed_seeds[a][sort_key] - parsed_seeds[b][sort_key];
      });
    }

    async function create_collection_entry(offset, seed, hide_seed, show_palette){
      var id = offset;
      var entry = document.createElement('div');
      entry.id = id;
      entry.className = 'collection_box';
      entry.setAttribute('data-seed', seed);  // For access with onclick
      entry.onclick = doSeedOnclick;
      var label = document.createElement('label');
      var scale_canvas = document.createElement("canvas");
      scale_canvas.width = 66;
      scale_canvas.height = 66;
      var scale_ctx = scale_canvas.getContext("2d");
      scale_ctx.imageSmoothingEnabled = false;
      // Strip any positional info
      seed = seed.replace(/%[\d .]*/g,'');
      if(seed.startsWith("!")){
        normalization_canvas = document.createElement("canvas");
        normalization_canvas.width = 32;
        normalization_canvas.height = 32;
        var normalization_ctx = normalization_canvas.getContext("2d");
        normalization_ctx.imageSmoothingEnabled = false;
        let ref_img = await refs[all_named[seed.slice(1)]];
        normalization_ctx.drawImage(ref_img, 16-ref_img.width/2, 32-ref_img.height);
        scale_ctx.drawImage(normalization_canvas, 0, 0, 64, 64);
      } else {
      if(seed.length != 10){
        alert("You seem to have a malformed seed! Seeds are 10 characters long, but got \""+seed+"\". Skipping!");
      }
      else {
        var plant_canvas = await gen_plant(decode_plant_data(seed), show_palette); // Maybe I should just scale the plants up in gen_plant...
        scale_ctx.drawImage(plant_canvas, 0, 0, 64, 64);
      }}
      label.htmlFor = id;
      label.className = 'collection_label';
      if(hide_seed){text_content = offset+1;} else {text_content = seed;}
      label.appendChild(document.createTextNode(text_content));
      let separator = document.createElement("span");
      separator.style.color = "transparent";
      separator.appendChild(document.createTextNode(", "));
      label.appendChild(separator);
      label.style.maxWidth = "86px";
      entry.appendChild(label);
      entry.style.background = 'url(' + scale_canvas.toDataURL() + ')  no-repeat bottom center';
      return entry;
    }

    // Exists solely to smooth use of setTimeout.
    async function add_collection_entry(parent, offset, seed, hide_seed, show_palette){
      child = await create_collection_entry(offset, seed, hide_seed, show_palette);
      parent.appendChild(child);
    }


    async function analyze_seed(seed_string) {
      var canvas = document.getElementById("analysis_output_canvas");
      var ctx = canvas.getContext("2d");
      if(seed_string[0] == "!"){
          item_name = seed_string.slice(1);
          var plant_canvas = await gen_named(item_name);
          canvas.setAttribute("hidden", "hidden");
      } else {
          canvas.removeAttribute("hidden");
          var raw_plant_data = decode_plant_data(seed_string);
          var plant_data = parse_plant_data(raw_plant_data);
          var img=new Image();
          img.src="https://i.imgur.com/rSLWUqw.png";  // palette preview image
          img.crossOrigin = "anonymous"
          img.onload = function() {
              ctx.drawImage(img, 0, 0);
              var new_overall_palette = plant_data["foliage_palette"].concat(plant_data["accent_palette"]).concat(plant_data["feature_palette"]);
              replace_color_palette(overall_palette, new_overall_palette, ctx, 64, 64);
          };
          var plant_canvas = await gen_plant(raw_plant_data); // Maybe I should just scale the plants up in gen_plant...
      }
      var preview_canvas = document.getElementById("analysis_preview_canvas");
      var preview_ctx = preview_canvas.getContext("2d");
      preview_ctx.clearRect(0, 0, preview_canvas.width, preview_canvas.height);
      preview_ctx.imageSmoothingEnabled = false;
      preview_ctx.drawImage(plant_canvas, 0, 0, preview_canvas.width, preview_canvas.height);
      var text_output = document.getElementById("analysis_output_text");
      if(seed_string[0] == "!"){
          text_output.innerText = "Name: " + item_name + "\nArtist: " + reformatted_named[item_name]["artist"]
      } else {
          color_msg = ""
          if(plant_data["foliage"] == 160){
            color_msg += "This seed is malformed"
          } else {
            for(category of ["foliage_palette", "feature_palette", "accent_palette"]){
              let link_color = "#"+plant_data[category][0];
              color_msg += ("<a href='javascript:forceFilter(-1, " + raw_plant_data[category] + ");' style='text-decoration-color: " + link_color + "'><span style='color: " + link_color + "'>" + all_palettes[raw_plant_data[category]]["categories"]+"<\a><\span> ");
            }
          }
          text_output.innerHTML = ("Name: "+all_foliage[plant_data["foliage"]]["name"]+
          "<br>Artist: "+all_foliage[plant_data["foliage"]]["artist"]+
          "<br>Type: <a href='javascript:forceFilter(" + plant_data["foliage"] + ", -1);'>"+all_foliage[plant_data["foliage"]]["categories"]+"<\a>"+
          "<br>Colors: " + color_msg);
          //"<br>Colors: <a href='javascript:forceFilter(-1, " + plant_data["foliage_palette"] + ");'>"+all_palettes[raw_plant_data["foliage_palette"]]["categories"]+"<\a>");
      }//text_output.innerText = `Base: ${raw_plant_data["foliage"]}`+"\n"+`Simple Feature: ${raw_plant_data["simple_feature"]}`+"\n"+`Complex Feature: ${raw_plant_data["complex_feature"]}`;
  }

    async function do_preload() {
        await preload_plants();
        await preload_named();
        display_collection();
        base_sort_div = document.getElementById("base_sort_categories_div");
        for(category of Object.keys(foliage_by_category)){
          makeSortCheckmark("base_sort_", category, base_sort_div);
        }
        palette_sort_div = document.getElementById("palette_sort_categories_div");
        for(palette of Object.keys(palettes_by_category)){
          makeSortCheckmark("palette_sort_", palette, palette_sort_div);
        }
        if(localStorage["last_backup"] == undefined) { localStorage["last_backup"] = new Date()}
        days_since_backup = Math.round((+new Date() - +new Date(localStorage["last_backup"]))/8.64e7);
        if(days_since_backup > 0){
          document.getElementById("backup_button").value = "Backup (+"+Math.min(days_since_backup*backup_sp_per_day, max_sp_for_backup)+" sp)";
        }
    }
  </script>
</body>
</html>
